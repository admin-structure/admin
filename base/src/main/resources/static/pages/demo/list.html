<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>test</title>

    <link rel="stylesheet" type="text/css" media="all" href="../../plugins/timeSeleter/daterangepicker-bs3.css"/>
    <link rel="stylesheet" href="../../assets/css/main.css">

    <!-- DataTables -->
    <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.css">

    <style>
        html {
            -ms-overflow-style: none;
            overflow: -moz-scrollbars-none;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .importHidden {
            display: none;
        }

        .dataTables_info {
            float: left;
        }

        thead th {
            border-bottom: 0 !important;
        }

        i {
            font-size: 16px;
            margin-right: 5px;
        }

        .spacing {
            margin-left: 6px;
        }

        .modal-dialog {
            position: absolute !important;
            top: 40% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            -webkit-transform: translate(-50%, -50%) !important;
            -moz-transform: translate(-50%, -50%) !important;
            -ms-transform: translate(-50%, -50%) !important;
            -o-transform: translate(-50%, -50%) !important;
        }

        @media only screen and (max-width: 980px) {

            tr th:nth-child(10),
            tr td:nth-child(10) {
                display: none !important;
                visibility: hidden !important;
            }

            tr th:nth-child(11),
            tr td:nth-child(11) {
                display: none !important;
                visibility: hidden !important;
            }
        }

        @media only screen and (max-width: 860px) {

            tr th:nth-child(6),
            tr td:nth-child(6) {
                display: none !important;
                visibility: hidden !important;
            }

            tr th:nth-child(7),
            tr td:nth-child(7) {
                display: none !important;
                visibility: hidden !important;
            }
        }

        @media only screen and (max-width: 740px) {

            tr th:nth-child(5),
            tr td:nth-child(5) {
                display: none !important;
                visibility: hidden !important;
            }

        }

        @media only screen and (max-width: 490px) {

            tr th:nth-child(2),
            tr td:nth-child(2) {
                display: none !important;
                visibility: hidden !important;
            }

        }

        @media only screen and (max-width: 450px) {

            tr th:nth-child(5),
            tr td:nth-child(5) {
                display: none !important;
                visibility: hidden !important;
            }

        }
    </style>
</head>

<body>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="col-md-6">
                    <h5><i class="pe-7s-note2" style="font-size: 22px;margin-right: 10px;"></i>城际线路班次管理</h5>
                </div>
                <div style="display: flex;flex-direction: row;justify-content: flex-end;" class="col-md-6">
                    <a href="javascript:void (0);">
                        <button class="btn btn-primary "
                                id="insertButton"><i class="pe-7s-plus"></i><span>新增</span></button>
                    </a>
                    <button class="btn btn-primary  spacing" data-toggle="collapse" href="#collapseExample123" id="ha"
                            onclick="searchButton()"><i class="pe-7s-filter"></i><span id="searchText">查询</span>
                    </button>
                    <button class="btn btn-primary  spacing"><i class="pe-7s-up-arrow"></i><span>导出</span></button>
                </div>
            </div>
            <div class="main-card">
                <div class="card-body" style="padding: 20px 40px !important;">
                    <div class="collapse" id="collapseExample123">
                        <div class="form-row">
                            <div class="col-md-2">
                                <div class="position-relative form-group"><label for="routeName">路线名称</label><input
                                        name="routeName"
                                        id="routeName" type="text" class="form-control"></div>
                            </div>
                            <div class="col-md-2">
                                <div class="position-relative form-group"><label for="carNumber"
                                                                                 class="">车牌号</label><input
                                        name="carNumber" id="carNumber" type="text" class="form-control"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="position-relative form-group"><label for="carTime" class="">发车时间</label>
                                    <div class="position-relative form-group">
                                        <form class="form-horizontal">
                                            <fieldset>
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <div class="input-prepend input-group"
                                                             style="flex-wrap:nowrap;">
                                <span class="add-on input-group-addon"
                                      style="padding: 6px 12px;font-size: 14px;font-weight: normal;line-height: 1;border-radius: 4px;
                                                border-right: 0;border-top-right-radius: 0;border-bottom-right-radius: 0;
                                                color: #555555;text-align: center;background-color: #eeeeee;border: 1px solid #cccccc;">
                                  <i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
                                                            <input type="text" style="width: 400px" name="carTime"
                                                                   id="carTime" class="form-control"
                                                                   placeholder="请选择发车时间区间" class="span4"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </fieldset>
                                        </form>
                                    </div>
                                </div>

                            </div>
                            <div class="col-md-2" style="margin-left: 30px;">
                                <button class="btn btn-primary " id="search" style="margin-top: 1.9rem"><i
                                        class="pe-7s-search"></i>搜索
                                </button>
                                <button class="btn btn-primary  spacing" id="clean" style="margin-top: 1.9rem"><i
                                        class="pe-7s-trash"></i>重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="padding: 15px 20px;">
                    <div style="display: flex;">
                        <div style="display: flex; align-items: center;" class="col-md-2">
                            <label for="Select1"
                                   style="font-size: 16px; margin-right: 6px;min-width: 84px;">是否热门:</label>
                            <select name="select" id="Select1" class="form-control ">
                                <option>是</option>
                                <option>否</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center;" class="col-md-2">
                            <label for="Select2"
                                   style="font-size: 16px; margin-right: 6px;min-width: 84px;">售票状态:</label>
                            <select name="select" id="Select2" class="form-control ">
                                <option>开启</option>
                                <option>关闭</option>
                            </select>
                        </div>
                    </div>
                    <table id="oper-demo" class="table table-bordered table-hover dataTable dtr-inline">
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- jQuery -->
<script src="../../plugins/jquery/jquery.min.js"></script>
<!-- ../../wrapper -->
<script src="../../assets/scripts/main.js"></script>

<script src="../../plugins/axios.js"></script>
<!-- DataTables -->
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>

<script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.html5.js"></script>
<script src="../../plugins/jszip/jszip.js"></script>
<!-- daterangepicker -->
<script type="text/javascript" src="../../plugins/timeSeleter/moment.js"></script>
<script type="text/javascript" src="../../plugins/timeSeleter/daterangepicker.js"></script>

</body>

<script>

    function searchButton() {
        let text = $("#searchText").text();
        if (text === "查询") {
            $("#searchText").text("隐藏");
            $("#ha i").removeClass("pe-7s-filter").addClass("pe-7s-angle-up-circle")
        } else {
            $("#searchText").text("查询");
            $("#ha i").removeClass("pe-7s-angle-up-circle").addClass("pe-7s-filter")
        }
    }

    $("#clean").click(function () {
        $('.form-row input').val("");
    });


    ;(function () {
        // 数据初始化
        let pageSize = 10; // 每页条数
        let myDataTable;
        let searchMap = {}; // 查条件

        // 重新渲染table
        function search() {
            searchMap = {};
            let routeName = $("#routeName").val();
            let carNumber = $("#carNumber").val();
            let founder = $("#founder").val();
            let carTime = $("#carTime").val();
            searchMap["routeName"] = routeName;
            searchMap["carNumber"] = carNumber;
            searchMap["founder"] = founder;
            searchMap["carTime"] = carTime;
            newMyDataTable();
        }

        // -------------------------start---------------------------------------

        $(() => {
            // 新增
            $('#insertButton').on("click", () => {
                // create obj to push array
                let addObj = {
                    url: "./pages/demo/addPage.html",
                    name: "新增demo页",
                    standup: true
                };
                // show tabs and iframe , manage arrow btn
                parent.operateData(addObj)
            })
            // 编辑
            $('#oper-demo').on("click", "button#editRow", (e) => {
                let editObj = {
                    url: "./pages/demo/editPage.html",
                    name: "编辑demo页",
                    standup: true
                };
                parent.operateData(editObj)
                /*let rowIndex = $(e.currentTarget).parents("tr").index(); // 0
                let id = $("#oper-demo")[0].tBodies[0].rows[rowIndex].cells[0].innerText;
                $("#editBtn")[0].dataset.id = id; // 传递
                // 数据回显
                axios.get(`/frequency/findById/${id}`).then(res => {
                    fillFormData(res.data.data)
                })*/
            })

            //  进入页面去请求数
            newMyDataTable();
            $("#search").click(function () {
                search();
            });

            $('#carTime').daterangepicker({
                timePicker: true,
                timePickerIncrement: 30,
                format: 'MM/DD/YYYY h:mm A'
            }, function (start, end, label) {
                console.log(start.toISOString(), end.toISOString(), label);
            });
        })

        //表格渲染 data为二维数组
        function renderTable(searchMap) {
            myDataTable = $('#oper-demo').DataTable({
                // paging: true, // 分页
                lengthChange: false, //是否允许用户改变表格每页显示的记录数
                iDisplayLength: pageSize, // 默认条目数
                searching: false, // 禁搜索
                ordering: false,  // 排序开关
                info: true, // 是否显示左下角
                responsive: true,// 是否初始隐藏折叠按钮
                autoWidth: false, //禁用自动调整列宽
                stateSave: false, //状态保存，再次加载页面时还原表格状态
                serverSide: true, //启用服务器端分页
                pagingType: "simple_numbers",
                //--------------------------------------

                ajax: function (data, callback, settings) {
                    //封装请求参数
                    let param = {};
                    param.pageSize = data.length;//页面显示记录条数，在页面显示每页显示多少项的时候
                    param.currentPage = (data.start / data.length) + 1;//当前页码
                    param.searchMap = searchMap
                    //ajax请求数据
                    $.ajax({
                        type: "GET",
                        url: "/pages/demo/info.json",
                        cache: false, //禁用缓存
                        // data: JSON.stringify(param), //传入组装的参数
                        contentType: "application/json",
                        dataType: "json",
                        success: function (res) {
                            let returnData = {};
                            let result = res.data;
                            returnData.draw = data.draw;//这里直接自行返回了draw计数器,应该由后台返回
                            returnData.recordsTotal = result.totalRows;//返回数据全部记录
                            returnData.recordsFiltered = result.totalRows;//后台不实现过滤功能，每次查询均视作全部结果
                            returnData.data = toDatatableArray(result.items);//返回的数据列表
                            callback(returnData);
                        }
                    });
                },
                //--------------------------------------
                // dom: '<"pull-left"B>ft<"pull-left"i>p',
                buttons: [
                    'excel'
                ],
                columns: [{
                    title: "id",
                    className: "importHidden"
                },
                    {
                        title: '序号',
                        className: 'text-center whiteSpace',
                        render: function (data, type, row, meta) {
                            return meta.row + 1 + meta.settings._iDisplayStart;
                        }
                    },
                    {
                        title: "线路名",
                    },
                    {
                        title: "总票数(已售)"
                    },
                    {
                        title: "是否拼团"
                    },
                    {
                        title: "是否热门"
                    },
                    {
                        title: "售票状态(关闭，开启)"
                    },
                    {
                        title: "运行车辆",
                    },
                    {
                        title: "发车时间",
                    },
                    {
                        title: "创建人",
                    },
                    {
                        title: "创建时间",
                    },
                    {
                        title: '操作',
                        render: function (data, type, row, meta) {
                            return `<a href="javascript:void (0);" ><button class="btn btn-primary "
                id="editRow"><i class="pe-7s-note"></i><span>编辑</span></button></a>&ensp;<a href="javascript:void (0);" ><button class="btn btn-primary "id="editRow"><i class="pe-7s-trash"></i><span>删除</span></button></a>`;
                        }
                    }
                ],
                language: {
                    "buttons": {
                        "excel": "导出Excel"
                    },
                    "sProcessing": "处理中...",
                    "buttons.copy": "复制",
                    "buttons.print": "打印",
                    "sLengthMenu": "_MENU_",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                    "oAria": {
                        "sSortAscending": ": 以升序排列此列",
                        "sSortDescending": ": 以降序排列此列"
                    }
                }
            });
        }

        // datatables end

        // 请求过来的数据进行二次封装为datatables可识别
        function toDatatableArray(result) {
            let resultData = [];
            result.forEach(v => {
                let item = [];
                item.push(v.id, "", v.routeName, v.pickTotal + "(" + v.pickSale + ")", v.isTogether === 1 ? "是" : "否", v.isHot === 1 ? "是" : "否", v.isClose === 1 ? "关闭" : "开启", v.cars, v.carStartTime, v.createUser, v.createTime);
                resultData.push(item)
            })
            return resultData;
        }

        // 刷新
        function newMyDataTable() {
            if (myDataTable) {
                myDataTable.destroy()
                $("#oper-demo").empty()
            }
            renderTable(searchMap)
        }


        // 二次确认后的操作---------------
        // 删除
        this.deleteConfirm = function (dom) {
            let id = dom.dataset.id;
            axios.delete(`/frequency/delete?id=${id}`).then(res => {
                // 重新渲染
                newMyDataTable()
            })
            $("#myModal").modal('hide');
        }

        // 编辑
        this.editConfirm = function (ref) {
            let id = ref.dataset.id;
            let param = getFormDataEdit();
            param.id = id
            axios.put("frequency/update", param).then(res => {
                newMyDataTable()
                $("#myModal").modal('hide');
            })
        }

        // form数据填充
        function fillFormData(obj) {
            $("#myForm02").find("input[name='routeName']").val(obj.routeName);
            $("#myForm02").find("input[name='allTicket']").val(obj.pickTotal);
            $("#myForm02").find("input[name='plateNumbers']").val(obj.cars);
            $("#myForm02").find("input[name='carStartTime']").val(obj.carStartTime);
            $("#myForm02").find("input[name='check']")[0].checked = (obj.isTogether == 1 ? true : false);
            $("#myForm02").find("input[name='check']")[1].checked = (obj.isHot == 1 ? true : false);
            $("#myForm02").find("input[name='check']")[2].checked = (obj.isClose == 0 ? true : false);
        }

        // form数据采集 add
        function getFormData() {
            let formData = {};
            formData.routeName = $("#myForm").find("input[name='routeName']").val();
            formData.allTicket = $("#myForm").find("input[name='allTicket']").val();
            formData.plateNumbers = $("#myForm").find("input[name='plateNumbers']").val();
            formData.carStartTime = $("#myForm").find("input[name='carStartTime']").val();
            formData.isTogether = ($("#myForm").find("input[name='check']")[0].checked ? 1 : 0);
            formData.isHot = ($("#myForm").find("input[name='check']")[1].checked ? 1 : 0);
            formData.isClose = ($("#myForm").find("input[name='check']")[2].checked ? 0 : 1);
            formData.createUser = "leboy";
            return formData;
        }

        // form数据采集 edit
        function getFormDataEdit() {
            let formData = {};
            formData.routeName = $("#myForm02").find("input[name='routeName']").val();
            formData.allTicket = $("#myForm02").find("input[name='allTicket']").val();
            formData.plateNumbers = $("#myForm02").find("input[name='plateNumbers']").val();
            formData.carStartTime = $("#myForm02").find("input[name='carStartTime']").val();
            formData.isTogether = ($("#myForm02").find("input[name='check']")[0].checked ? 1 : 0);
            formData.isHot = ($("#myForm02").find("input[name='check']")[1].checked ? 1 : 0);
            formData.isClose = ($("#myForm02").find("input[name='check']")[2].checked ? 0 : 1);
            return formData;
        }


    }());

    function centerModals() {
        $('#myModal').each(function (i) {
            var $clone = $(this).clone().css('display', 'block').appendTo('body');
            var top = Math.round(($clone.height() - $clone.find('.modal-content').height()) / 2);
            top = top > 0 ? top : 0;
            $clone.remove();
            $(this).find('.modal-content').css("margin-top", top);
        });
    }

    $('#myModal').on('show.bs.modal', centerModals);
    $(window).on('resize', centerModals);
</script>




</html>